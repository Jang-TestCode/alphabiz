(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[11],{"309c":function(t,e,a){"use strict";(function(t){a.d(e,"c",(function(){return n})),a.d(e,"a",(function(){return r})),a.d(e,"b",(function(){return b}));a("ddb0"),a("a79d"),a("4069");var o=a("0613"),s=a("ed08"),l=(a("997a"),a("4aad")),i=a("f0e1");const n={data(){return{previewImage:null}},computed:{showPreview:{set(t){this.previewImage=t||null},get(){return!!this.previewImage}}}},r={data(){return{showSetFilmRate:!1,filmRate:{label:this.$t("rate_g"),value:"G",caption:this.$t("rate_g_desc")},filmRateOptions:[{label:this.$t("rate_g"),value:"G",caption:this.$t("rate_g_desc")},{label:this.$t("rate_pg"),value:"PG",caption:this.$t("rate_pg_desc")},{label:this.$t("rate_pg_13"),value:"PG-13",caption:this.$t("rate_pg_13_desc")},{label:this.$t("rate_r"),value:"R",caption:this.$t("rate_r_desc")},{label:this.$t("rate_nc_17"),value:"NC-17",caption:this.$t("rate_nc_17_desc")}]}},methods:{tryAutoSetFilmRate(){if(!o["a"].getters.accountUserInfo||!o["a"].getters.accountUserInfo.sub)return setTimeout((()=>this.tryAutoSetFilmRate()),2e3);const t=new Date(o["a"].getters.accountUserInfo.birthday);if(t&&t.valueOf()){const e=Date.now();return t.setFullYear(t.getFullYear()+7),console.log("User is more than 7 years old"),t.valueOf()<e?(this.filmRate.value="PG",t.setFullYear(t.getFullYear()+3),console.log("User is more than 10 years old"),t.valueOf()<e?(this.filmRate.value="PG-13",t.setFullYear(t.getFullYear()+3),console.log("User is more than 13 years old"),t.valueOf()<e?(this.filmRate.value="R",t.setFullYear(t.getFullYear()+4),console.log("User is more than 17 years old"),t.valueOf()<e&&(this.filmRate.value="NC-17"),this.setFilmRate()):this.setFilmRate()):this.setFilmRate()):this.setFilmRate()}this.showSetFilmRate=!0},setFilmRate(){if(o["a"].dispatch("updateSettings",{libraryRate:this.filmRate.value}),Object(s["isElectron"])()){const{ipcRenderer:t}=a("bdb9");t.send("set_settings",{libraryRate:this.filmRate.value})}localStorage.setItem("set-film-rate",this.filmRate.value),this.showSetFilmRate=!1}},activated(){localStorage.getItem("set-film-rate")||this.tryAutoSetFilmRate()}};t.$k=t.$k||{};const d=i["a"].blue.tags("LibLoader"),c=d.tags("Channel"),h=d.tags("Post"),u={data(){return{loader$loadedChannels:{}}},created(){this.$watch("followingChannels",(t=>{let e=!1;Object.keys(this.loader$loadedChannels).forEach((a=>{t.some((t=>t.id===a))||(delete this.loader$loadedChannels[a],e=!0)})),e&&(this.loader$loadedChannels=Object.assign({},this.loader$loadedChannels))}),{immediate:!0,deep:!0})},computed:{loader$toLoadChannels(){const t=this.followingChannels;return t.filter((t=>!(!t.title||!t.id)&&!this.loader$loadedChannels[t.id])).reduce(((t,e)=>(t[e.id]=e,t)),{})}},methods:{async loader$enableChannelsLoader({onLoaded:t},e){const a=async({onChannelLoaded:t,onChannelUpdated:e})=>{const a=Object.values(this.loader$toLoadChannels);await Promise.all(a.map((async a=>{const o=await l["a"].getChannelPostIds(a.id,!0);if(!this.loaderEnabled)return;const s=this.loader$loadedChannels[a.id];s?s.ids=o:this.loader$loadedChannels[a.id]={channel:a,ids:o},this.loader$loadedChannels=Object.assign({},this.loader$loadedChannels),await(s?e:t)(a.id)})))},o=()=>({toLoadCount:Object.keys(this.loader$toLoadChannels).length,loadedCount:Object.keys(this.loader$loadedChannels).length}),s=t=>new Promise((e=>setTimeout(e,t)));let i=!0;while(this.loaderEnabled){const l=o();if(!l.toLoadCount){if(i){t((()=>{const t=i;return i=!1,t})());continue}await s(e);continue}if(await a({onChannelLoaded:async t=>{if(!this.loaderEnabled)return;const{loadedCount:e,toLoadCount:a}=o(),s=`${e}/${e+a}`;c.tags("onLoaded",s).log(t)},onChannelUpdated:async t=>{this.loaderEnabled&&c.tags("onUpdated").log(t)}}),!this.loaderEnabled)break;const n=o();n.toLoadCount||(t((()=>{const t=i;return i=!1,t})()),await s(e))}}}},p={data(){return{loader$loadedPosts:{}}},computed:{loader$toLoadPosts(){return Object.values(this.loader$loadedChannels).map((({channel:t,ids:e})=>e.map((e=>({id:e,channelId:t.id}))))).flat(1).reduce(((t,e)=>(this.loader$loadedPosts[e.id]||(t[e.id]=e),t)),{})},loader$toLoadPostIdListSorted(){return Object.keys(this.loader$toLoadPosts).sort(((t,e)=>t&&e?t.localeCompare(e):0))},loader$loadedPostsMin(){const t=10;return Object.keys(this.loader$loadedPosts).length>=t}},methods:{async loader$enablePostsLoader({onLoaded:t},e){const a=async({onPostLoaded:t})=>{const e=async t=>{const{id:e,channelId:a}=t,o=this.loader$loadedChannels[a].channel,s=await l["a"].getPostById(a,e,!0);if(this.loaderEnabled)return s?(s.channel=o,s):null},a=t=>this.loader$toLoadPostIdListSorted.length?this.loader$toLoadPostIdListSorted.slice(0,t).map((t=>this.loader$toLoadPosts[t])):null,o=a(10);if(!o)return;let s=await Promise.all(o.map((async t=>{const a=await e(t);if(this.loaderEnabled&&a)return this.loader$loadedPosts[a.id]=a,a.id})));s=s.filter((t=>void 0!==t)),s.length&&(this.loader$loadedPosts=Object.assign({},this.loader$loadedPosts),await t(s))},o=()=>({toLoadCount:Object.keys(this.loader$toLoadPosts).length,loadedCount:Object.keys(this.loader$loadedPosts).length}),s=t=>new Promise((e=>setTimeout(e,t)));let i=!0;while(this.loaderEnabled){const l=o();if(!l.toLoadCount){if(i){t((()=>{const t=i;return i=!1,t})());continue}await s(e);continue}if(await a({onPostLoaded:async t=>{if(!this.loaderEnabled)return;const{loadedCount:e,toLoadCount:a}=o(),s=`${e}/${e+a}`;h.tags("onLoaded",s).log()}}),!this.loaderEnabled)break;const n=o();n.toLoadCount||(t((()=>{const t=i;return i=!1,t})()),await s(e))}}}},g={mixins:[u,p],data(){return{loaderState:"disabled"}},computed:{loaderEnabled(){return["loading","loaded","timeout","loading_timeout"].includes(this.loaderState)}},created(){this.$watch("loaderState",((t,e)=>{let a=d.tags("State",t);const o={red:["timeout"]},s=Object.keys(o).find((e=>o[e].includes(t)));s&&(a=a[s]);const l={timeout:"timeout, maybe network error",loading_timeout:"timeout, but still loading posts",loaded:()=>{const t={loading_timeout:"loaded but timeout"};return t[e]}};let i=l[t];"function"===typeof i&&(i=i()),i?a.log(i):a.log()}))},methods:{async enableLoader(){const t=t=>new Promise((e=>setTimeout(e,t))),e=async(e,a,o)=>{let s,l=!1;return await Promise.race([e.then((t=>{l=!0,s=t})),t(a).then((()=>{l||o&&(s=o())}))]),s};if(this.loaderEnabled)return;this.loaderState="loading";const a=1e4,o=async()=>{await new Promise((t=>this.loader$enableChannelsLoader({onLoaded:e=>{c.log(e?"loaded":"updated"),t(!0)}},1e4))),await new Promise((t=>this.loader$enablePostsLoader({onLoaded:e=>{h.log(e?"loaded":"updated"),t(!0)}},1e4)))},s=t=>{this.loaderEnabled&&(t?this.loader$loadedPostsMin?this.loaderState="loading_timeout":this.loaderState="timeout":this.loaderState="loaded")};await e((async()=>{await o(),s(!1)})(),a,(()=>{s(!0)}))},async disableLoader(){this.loaderEnabled&&(this.loaderState="disabled")}}},m={methods:{async loader$dialog(){const t=this.$alphabiz.dialog({title:this.$t("no_available_post"),message:this.$t("following_channel_no_post"),cancel:this.$t("cancel"),ok:this.$t("lib_explore")}),e=this.$watch("loader$loadedPostsMin",(a=>{a&&(e(),t.hide())})),a=await t.promise("ok");a&&(o["a"].getters.settings.libraryShowExplore||o["a"].dispatch("set",{libraryShowExplore:!0}),this.$root.$emit("navigate-to","/library/explore"),this.$router.push("/library/explore"))}}},b={mixins:[g,m],computed:{loadedPosts(){return this.loader$loadedPosts}},created(){t.$k.debugInstance=this,this.$watch("loaderState",(t=>{"timeout"===t&&this.loader$dialog()}))},async activated(){const t=()=>{const t=Object.values(this.loader$loadedChannels).map((({ids:t})=>t)).flat(1),e=Object.keys(this.loader$loadedPosts).filter((e=>!t.includes(e)));e.forEach((t=>{delete this.loader$loadedPosts[t]})),e.length&&(this.loader$loadedPosts=Object.assign({},this.loader$loadedPosts))};t(),await l["a"].whenReady,this.enableLoader()},deactivated(){this.disableLoader()}}}).call(this,a("c8ba"))},3660:function(t,e,a){"use strict";a.r(e);var o=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"library-index"},[a("q-virtual-scroll",{ref:"vscroll",staticClass:"library-index-scroll",class:{web:!t.isElectron},attrs:{separator:"","virtual-scroll-slice-size":10,"virtual-scroll-item-size":385,"items-size":t.searchFilteredPosts.length,"virtual-scroll-sticky-size-end":16,"items-fn":t.itemsFn},on:{"virtual-scroll":t.onScroll},scopedSlots:t._u([{key:"default",fn:function(e){var o=e.item;return[a("PostCard",{key:o.id,attrs:{post:o},on:{preview:function(e){return t.showPreview=e},follow:t.unfollow,"to-channel":t.toChannelPage}})]}},{key:"after",fn:function(){return[a("div",{directives:[{name:"show",rawName:"v-show",value:!t.searchFilteredPosts.length&&"loaded"===t.loaderState,expression:"!searchFilteredPosts.length && loaderState==='loaded'"}],staticClass:"empty-placeholder full-width text-center text-subtitle1 q-my-md"},[a("q-icon",{attrs:{name:"help_outline"}}),a("span",{staticClass:"empty-hint q-ml-sm"},[t._v(t._s(t.$t("credit_no_data")))])],1),a("div",{directives:[{name:"intersection",rawName:"v-intersection",value:t.shouldLoading,expression:"shouldLoading"}],staticClass:"full-width text-center"},["loaded"===t.loaderState?a("div",{staticClass:"loaded-all"},[a("div",{staticClass:"loaded-hint"},[t._v(t._s(t.$t("got_all_post")))]),a("q-icon",{staticClass:"q-mb-md",attrs:{name:"done",size:"32px",color:"primary"}})],1):a("div",{staticClass:"loading-infinite",class:{transparent:t.showLoadingBackdrop}},[a("div",{staticClass:"loading-hint"},[t._v(t._s(t.$t("loading"))+" ...")]),a("q-circular-progress",{staticClass:"q-ma-md",attrs:{indeterminate:"",size:"32px",color:"primary"}})],1)])]},proxy:!0}])}),a("BackToTop",{attrs:{show:t.scrollIndex>0},on:{click:t.scrollTop}}),a("SearchChannel",{attrs:{higher:t.scrollIndex>0}}),a("q-dialog",{model:{value:t.showPreview,callback:function(e){t.showPreview=e},expression:"showPreview"}},[a("q-card",{staticClass:"image-preview-card"},[a("q-card-section",{staticClass:"q-pa-none"},[a("img",{staticClass:"preview-image",attrs:{src:t.previewImage}})]),a("q-card-actions",{staticClass:"q-pa-none",staticStyle:{position:"absolute",bottom:"0",right:"0"},attrs:{align:"right"}},[a("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",padding:"none",size:"20px",icon:"close",color:"grey"}})],1)],1)],1),a("q-dialog",{attrs:{persistent:""},model:{value:t.showSetFilmRate,callback:function(e){t.showSetFilmRate=e},expression:"showSetFilmRate"}},[a("q-card",[a("q-card-section",[a("div",{staticClass:"text-h6 title"},[t._v(t._s(t.$t("set_film_rate")))]),a("div",{staticClass:"text hint"},[t._v(t._s(t.$t("select_a_rate_before_enter")))]),a("q-select",{staticStyle:{width:"320px"},attrs:{"display-value":t.filmRate.label,options:t.filmRateOptions,outlined:"",dense:"","data-cy":"select-direct"},scopedSlots:t._u([{key:"option",fn:function(e){return[a("q-item",t._g(t._b({},"q-item",e.itemProps,!1),e.itemEvents),[a("q-item-section",[a("q-item-label",{domProps:{innerHTML:t._s(e.opt.label)}}),e.opt.caption?a("q-tooltip",t._l(e.opt.caption.split("\n"),(function(e,o){return a("span",{key:o,staticClass:"tooltip"},[t._v(t._s(e))])})),0):t._e()],1)],1)]}}]),model:{value:t.filmRate,callback:function(e){t.filmRate=e},expression:"filmRate"}})],1),a("q-card-actions",{attrs:{align:"right"}},[a("q-btn",{attrs:{flat:"",color:"primary"},on:{click:t.setFilmRate}},[t._v(t._s(t.$t("ok")))])],1)],1)],1),a("Loading",{attrs:{value:t.showLoadingBackdrop}})],1)},s=[],l=(a("e01a"),a("4aad")),i=a("2de9"),n=a("0ebe"),r=a("ed08"),d=a("ab9a"),c=a("6277"),h=a("309c"),u={name:"LibraryIndex",components:{PostCard:i["a"],Loading:d["a"],SearchChannel:c["a"],BackToTop:n["a"]},mixins:[h["c"],h["a"],h["b"]],data(){return{isElectron:Object(r["isElectron"])(),scrollStart:0,scrollSize:0,scrollIndex:0,loadingIntersecting:!0,lib:l["a"]}},computed:{showLoadingBackdrop(){return"ready"===l["a"].libStatus&&["loading","loading_timeout"].includes(this.loaderState)&&!this.filteredPosts.length},currentScrollTop(){return this.$refs.vscroll},followingChannels(){var t,e;const a=(null===(t=l["a"].userData)||void 0===t?void 0:t.blockChannels)||[],o=(null===(e=l["a"].userData)||void 0===e?void 0:e.blockUsers)||[];return l["a"].followingChannels.filter((t=>!a.includes(t.id)&&!o.includes(t.creator)))},filteredPosts(){return Object.values(this.loadedPosts).filter((t=>l["a"].isValidRate(t.rate||"G")))},searchFilteredPosts(){const t=l["a"].search.text.toLowerCase(),e=l["a"].search.option.value,a=t=>{var a;switch(e){case"channel":return null===(a=t.channel)||void 0===a?void 0:a.title;case"channelID":return t.channel.id;case"description":return t.description;default:return t.title}},o=e=>{var o;return null===(o=a(e))||void 0===o?void 0:o.toLowerCase().includes(t)};return this.filteredPosts.filter(o)},scrollPosts(){return this.searchFilteredPosts.slice(this.scrollStart,this.scrollStart+this.scrollSize)}},methods:{scrollTop(){this.$refs.vscroll.scrollTo(0,"start")},onScroll(t){this.scrollIndex=t.index||0},shouldLoading(t){},itemsFn(t=0,e=5){return this.scrollStart=t,this.scrollSize=e,this.scrollPosts},async unfollow(t){const e=this.$alphabiz.dialog({title:this.$t("unfollow"),message:this.$t("unfollow_confirm"),ok:this.$t("unfollow"),cancel:this.$t("cancel")}),a=await e.promise("ok");if(!a)return;const o=await l["a"].unfollowChannel(t);console.log("unfollowed",t,o)},toChannelPage(t){console.log("to",t);const e=["id","title"].map((e=>{const a=t[e];return encodeURIComponent(e)+"="+encodeURIComponent(a)})).join("&"),a=`/library/channel?${e}`;this.$root.$emit("navigate-to",a),this.$router.push(a)},setSearch(){this.lib.setSearchOption([{label:this.$t("post_title"),value:"post"},{label:this.$t("description"),value:"description"},{label:this.$t("channel_title"),value:"channel"},{label:this.$t("channel_id"),value:"channelID"}])}},mounted(){this.setSearch()},async activated(){this.$root.$emit("navigate-to"),this.setSearch()}},p=u,g=(a("a6d8"),a("2877")),m=a("a12b"),b=a("0016"),f=a("58ea"),w=a("24e8"),v=a("f09f"),$=a("a370"),y=a("4b7e"),C=a("9c40"),_=a("ddd8"),P=a("66e5"),S=a("4074"),L=a("0170"),k=a("05c0"),x=a("9748"),R=a("7f67"),O=a("eebe"),I=a.n(O),F=Object(g["a"])(p,o,s,!1,null,"59e21477",null);e["default"]=F.exports;I()(F,"components",{QVirtualScroll:m["a"],QIcon:b["a"],QCircularProgress:f["a"],QDialog:w["a"],QCard:v["a"],QCardSection:$["a"],QCardActions:y["a"],QBtn:C["a"],QSelect:_["a"],QItem:P["a"],QItemSection:S["a"],QItemLabel:L["a"],QTooltip:k["a"]}),I()(F,"directives",{Intersection:x["a"],ClosePopup:R["a"]})},"4f1b":function(t,e,a){},a6d8:function(t,e,a){"use strict";a("4f1b")},f0e1:function(t,e,a){"use strict";a("ddb0"),a("e9c4");const o=!0,s=function(t={},...e){if(!o)return;const{tags:a,type:s,styles:l}=Object.assign({tags:[],type:"log",styles:[{bgc:"rgb(247,247,247)",color:"black"},{bgc:"rgb(96,96,96)",color:"white"}]},t),i=Array.from(a,((t,e)=>{const o=l[(e+1)%2],s=[`background-color: ${o.bgc}`,`color: ${o.color}`];return s.push("padding: 2px 12px"),0===e&&s.push("border-top-left-radius: 8px","border-bottom-left-radius: 8px"),e===a.length-1&&s.push("border-top-right-radius: 8px","border-bottom-right-radius: 8px"),s.join("; ")})),n=a.map((t=>`%c${t}`)).join("");console[s](n,...i,...e)},l={log:{type:"log"},warn:{type:"warn"},error:{type:"error"},red:{styles:[{bgc:"rgb(248,160,160)",color:"black"},{bgc:"rgb(134,12,12)",color:"white"}]},green:{styles:[{bgc:"rgb(160,248,161)",color:"black"},{bgc:"rgb(35,154,17)",color:"white"}]},purple:{styles:[{bgc:"rgb(200,184,255)",color:"black"},{bgc:"rgb(44,31,162)",color:"white"}]},blue:{styles:[{bgc:"rgb(184,215,255)",color:"black"},{bgc:"rgb(31,107,162)",color:"white"}]},tags:t=>(...e)=>(t.options.tags=t.options.tags||[],t.options.tags.push(...e),i(t))},i=t=>new Proxy(t,{get(t,e,a){if("options"===e)return t.options||void 0;if(!Object.keys(l).includes(e))return;const o=(...t)=>s(o.options,...t);return o.options={},Object.assign(o.options,JSON.parse(JSON.stringify(t.options||{}))),"function"===typeof l[e]?l[e](o):(Object.assign(o.options,l[e]),i(o))}}),n=i(s);Object.defineProperties(s,Object.keys(l).reduce(((t,e)=>(t[e]={get(){return n[e]}},t)),{})),e["a"]=s}}]);