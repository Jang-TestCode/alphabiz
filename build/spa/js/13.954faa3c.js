(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[13],{"163f":function(t,e,s){"use strict";s.r(e);var l=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"library-explore"},[s("q-virtual-scroll",{ref:"vscroll",staticClass:"explore-scroll",class:{web:!t.isElectron},attrs:{separator:"",items:t.searchFilteredPosts,"virtual-scroll-slice-size":10,"virtual-scroll-item-size":385,"virtual-scroll-sticky-size-end":16},on:{"virtual-scroll":t.onScroll},scopedSlots:t._u([{key:"default",fn:function(e){var l=e.item;return[s("PostCard",{key:l.id,attrs:{followable:"",post:l},on:{preview:t.showPreviewImage,follow:t.follow,"to-channel":t.toChannelPage}})]}},{key:"after",fn:function(){return[s("div",{directives:[{name:"show",rawName:"v-show",value:!t.searchFilteredPosts.length&&!t.loadingPosts&&t.loadedAll,expression:"!searchFilteredPosts.length && !loadingPosts && loadedAll"}],staticClass:"full-width text-center text-subtitle1 q-my-md"},[s("q-icon",{attrs:{name:"help_outline"}}),t._v("\n        "+t._s(t.$t("credit_no_data"))+"\n      ")],1),s("div",{directives:[{name:"intersection",rawName:"v-intersection",value:t.shouldLoading,expression:"shouldLoading"}],staticClass:"full-width text-center"},[t.loadedAll&&!t.loadingPosts?s("div",{staticClass:"loaded-all"},[s("div",{staticClass:"loaded-hint"},[t._v(t._s(t.$t("got_all_post")))]),s("q-icon",{staticClass:"q-mb-md",attrs:{name:"done",size:"32px",color:"primary"}})],1):s("div",{staticClass:"loading-infinite",class:{transparent:t.loadingPosts&&!t.filteredPosts.length}},[s("div",{staticClass:"loading-hint"},[t._v(t._s(t.$t("loading"))+" ...")]),s("q-circular-progress",{staticClass:"q-ma-md",attrs:{indeterminate:"",size:"32px",color:"primary"}})],1)])]},proxy:!0}])}),s("BackToTop",{attrs:{show:t.scrollIndex>0},on:{click:t.scrollTop}}),s("SearchChannel",{attrs:{higher:t.scrollIndex>0}}),t.allPosts.length||t.loadingPosts?t._e():s("div",{staticClass:"no-data"},[s("q-btn",{staticClass:"no-data-btn",attrs:{round:"",color:"primary",icon:"arrow_forward",size:"24px"},on:{click:t.goToFollowing}},[s("q-tooltip",[t._v(t._s(t.$t("no_recommend"))+" "+t._s(t.$t("lib_following")))])],1)],1),s("q-dialog",{model:{value:t.showPreview,callback:function(e){t.showPreview=e},expression:"showPreview"}},[s("q-card",{staticClass:"image-preview-card"},[s("q-card-section",{staticClass:"q-pa-none"},[s("img",{staticClass:"preview-image",attrs:{src:t.previewImage}})]),s("q-card-actions",{staticClass:"q-pa-none",staticStyle:{position:"absolute",bottom:"0",right:"0"},attrs:{align:"right"}},[s("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",padding:"none",size:"20px",icon:"close",color:"grey"}})],1)],1)],1),s("Loading",{attrs:{value:t.loadingPosts&&!t.filteredPosts.length}})],1)},o=[],i=(s("ddb0"),s("4aad")),a=s("2de9"),n=s("0ebe"),d=s("ab9a"),r=s("6277"),h=s("997a"),c=s("ed08"),u={name:"LibraryExplore",components:{PostCard:a["a"],BackToTop:n["a"],SearchChannel:r["a"],Loading:d["a"]},data(){return{isElectron:Object(c["isElectron"])(),showPreview:!1,previewImage:"",loadingPosts:!1,loadTimer:null,allPosts:[],loadingNext:!1,loadedAll:!0,loadedChannels:[],loadedPostIds:[],scrollIndex:0,loadingIntersecting:!1,loadStartTime:Date.now(),lib:i["a"]}},computed:{nonFollowingChannels(){const t=this.lib.followingChannels.map((t=>t.id)),e=this.lib.userData.blockChannels,s=this.lib.userData.blockUsers;return this.lib.channelList.filter((l=>!e.includes(null===l||void 0===l?void 0:l.id)&&(!s.includes(null===l||void 0===l?void 0:l.creator)&&!t.includes(null===l||void 0===l?void 0:l.id)))).filter((t=>t))},filteredPosts(){return this.allPosts.filter((t=>i["a"].isValidRate(t.rate||"G")))},searchFilteredPosts(){const t=i["a"].search.text.toLowerCase(),e=i["a"].search.option.value,s=t=>{switch(e){case"channel":return t.channel.title;case"channelID":return t.channel.id;default:return t.title}},l=l=>{var o,i;if(!l||!l.title)return!1;const a=null===(o=s(l))||void 0===o?void 0:o.toLowerCase();return"channelID"===e&&t===a||(null===(i=l.channel)||void 0===i||!i.hidden)&&a.includes(t)};return this.filteredPosts.filter(l)},allPostToFetch(){const t=[];return this.loadedChannels.forEach((({channel:e,ids:s})=>{s.forEach((s=>{this.loadedPostIds.includes(s)||t.push({channel:e,postId:s})}))})),t}},methods:{onScroll(t){this.scrollIndex=t.index},scrollTop(){this.$refs.vscroll.scrollTo(0,"start")},shouldLoading(t){this.loadingIntersecting=t.isIntersecting,t.isIntersecting&&this.loadNext()},async loadNext(){if(this.loadingNext)return;this.loadingNext=!0;const t=this.allPostToFetch.slice(0,10).sort(((t,e)=>t.postId&&e.postId?t.postId.localeCompare(e.postId):0));if(Object(h["a"])("Load Next",t),!t.length)return this.loadingNext=!1,this.loadedAll=!0,void setTimeout((()=>{Object(h["a"])("try load more"),this.loadPostList()}),3e3);this.loadedAll=!1;const e=await Promise.all(t.map((async({channel:t,postId:e})=>({channel:t,post:await i["a"].getPostById(t.id,e,!0)}))));Object(h["a"])("fetch results",e),e.forEach((({channel:t,post:e})=>{e&&"object"===typeof e&&(e.channel=t,this.allPosts.push(e))})),this.loadedPostIds.push(...t.map((t=>t.postId))),this.loadingNext=!1,this.$nextTick((()=>{this.loadingIntersecting&&this.loadNext()}))},loadPostList(){if(this.loadStartTime+15e3<Date.now())return void(this.loadingPosts=!1);if(this.loadingPosts)return;this.loadingPosts=!0,Object(h["a"])("load all",this.nonFollowingChannels);for(let e=0;e<this.loadedChannels.length;e++)this.nonFollowingChannels.some((t=>t.id===this.loadedChannels[e].channel.id))||this.loadedChannels.splice(e--,1);const t=this.nonFollowingChannels.filter((t=>!(!t.title||!t.id)&&!this.loadedChannels.find((e=>e.channel.id===t.id))));Promise.all(t.map((t=>i["a"].getChannelPostIds(t.id,!0).then((e=>{const s=this.loadedChannels.find((e=>e.channel.id===t.id));if(s?e.forEach((t=>{s.ids.includes(t)||s.ids.push(t)})):this.loadedChannels.push({channel:t,ids:e}),!this.allPosts.length){if(this.loadedChannels.length<3&&this.nonFollowingChannels.length>2)return;this.loadNext()}}))))).then((()=>{this.allPosts.length?this.loadingPosts=!1:setTimeout((()=>{this.loadingPosts=!1,this.allPosts.length||this.loadPostList()}),2e3),this.loadingIntersecting&&this.loadNext()}))},prune(){const t=this.nonFollowingChannels.map((t=>t.id));for(let l=0;l<this.loadedChannels.length;l++)t.includes(this.loadedChannels[l].channel.id)||this.loadedChannels.splice(l--,1);const e=this.loadedChannels.reduce(((t,e)=>(e.ids&&t.push(...e.ids),t)),[]);for(let l=0;l<this.allPosts.length;l++){var s;const o=this.loadedPostIds.findIndex((t=>this.allPosts[l].id===t));t.includes(null===(s=this.allPosts[l].channel)||void 0===s?void 0:s.id)&&e.includes(this.allPosts[l].id)||(this.allPosts.splice(l--,1),-1!==o&&this.loadedPostIds.splice(o,1))}for(let l=0;l<this.loadedPostIds.length;l++)this.allPosts.find((t=>t.id===this.loadedPostIds[l]))||this.loadedPostIds.splice(l--,1)},showPreviewImage(t){this.previewImage=t,this.showPreview=!0},toChannelPage(t){Object(h["a"])("to",t);const e=["id","title"].map((e=>{const s=t[e];return encodeURIComponent(e)+"="+encodeURIComponent(s)})).join("&"),s=`/library/channel?${e}`;this.$root.$emit("navigate-to",s),this.$router.push(s)},follow(t){this.lib.followChannel(t).then((e=>{Object(h["a"])("followed",t,e)}))},goToFollowing(){this.$router.push("/library/following")},setSearch(){this.lib.setSearchOption([{label:this.$t("post_title"),value:"post"},{label:this.$t("channel_title"),value:"channel"},{label:this.$t("channel_id"),value:"channelID"}])}},activated(){this.prune(),this.$root.$emit("navigate-to"),this.$root.$emit("navigate-to","/library/explore"),this.loadStartTime=Date.now(),this.loadPostList();const t=this;"explore"in window||Object.defineProperty(window,"explore",{get(){return t.loadedChannels}})},mounted(){this.loadPostList(),this.setSearch()},watch:{nonFollowingChannels(t,e){if(t.length!==e.length){for(let e=0;e<this.loadedChannels.length;e++)t.some((t=>t.id===this.loadedChannels[e].channel.id))||this.loadedChannels.splice(e--,1);this.loadPostList()}}},beforeRouteEnter(t,e,s){s((t=>{e.path.startsWith("/library")&&t.setSearch()}))},beforeRouteLeave(t,e,s){clearTimeout(this.loadTimer),s()}},p=u,g=(s("525b"),s("2877")),f=s("a12b"),v=s("0016"),w=s("58ea"),P=s("9c40"),m=s("05c0"),C=s("74f7"),b=s("cf57"),I=s("24e8"),x=s("f09f"),_=s("a370"),y=s("4b7e"),T=s("9748"),$=s("7f67"),L=s("eebe"),q=s.n(L),S=Object(g["a"])(p,l,o,!1,null,"8a171840",null);e["default"]=S.exports;q()(S,"components",{QVirtualScroll:f["a"],QIcon:v["a"],QCircularProgress:w["a"],QBtn:P["a"],QTooltip:m["a"],QInnerLoading:C["a"],QSpinnerGears:b["a"],QDialog:I["a"],QCard:x["a"],QCardSection:_["a"],QCardActions:y["a"]}),q()(S,"directives",{Intersection:T["a"],ClosePopup:$["a"]})},"525b":function(t,e,s){"use strict";s("c4a1")},c4a1:function(t,e,s){}}]);