(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[16],{3660:function(e,t,o){"use strict";o.r(t);var a=function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{staticClass:"library-index"},[o("q-virtual-scroll",{ref:"vscroll",staticClass:"library-index-scroll",class:{web:!e.isElectron},attrs:{separator:"","virtual-scroll-slice-size":10,"virtual-scroll-item-size":385,"items-size":e.searchFilteredPosts.length,"virtual-scroll-sticky-size-end":16,"items-fn":e.itemsFn},on:{"virtual-scroll":function(t){return e.scrollIndex=t.index||0}},scopedSlots:e._u([{key:"default",fn:function(t){var a=t.item;return[o("PostCard",{key:a.id,attrs:{post:a},on:{preview:function(t){return e.showPreview=t},follow:e.unfollow,"to-channel":e.toChannelPage}})]}},{key:"after",fn:function(){return[o("div",{directives:[{name:"intersection",rawName:"v-intersection",value:e.fetchNext,expression:"fetchNext"}],staticClass:"flex justify-center items-center",class:e.searchFilteredPosts.length?["q-py-xl"]:["full-height"],style:{marginTop:e.searchFilteredPosts.length?"-16px":"0"}},["loaded"!==e.loaderState||e.searchFilteredPosts.length?"loaded"===e.loaderState?[o("q-icon",{attrs:{name:"check_circle_outline",size:"1.2rem"}}),o("div",{staticClass:"q-ml-sm"},[e._v(e._s(e.$t("got_all_post")))])]:[o("q-spinner-ios",{attrs:{size:"1.2rem",color:"general"}}),o("div",{staticClass:"q-ml-sm"},[e._v(e._s(e.$t("loading"))+"...")])]:[o("q-icon",{attrs:{name:"error_outline",size:"1.2rem"}}),o("div",{staticClass:"q-ml-sm"},[e._v(e._s(e.$t("credit_no_data")))])]],2)]},proxy:!0}])}),o("BackToTop",{attrs:{show:e.scrollIndex>0},on:{click:function(t){return e.$refs.vscroll.scrollTo(0,"start")}}}),o("SearchChannel",{attrs:{higher:e.scrollIndex>0}}),o("q-dialog",{model:{value:e.showPreview,callback:function(t){e.showPreview=t},expression:"showPreview"}},[o("q-card",{staticClass:"image-preview-card"},[o("q-card-section",{staticClass:"q-pa-none"},[o("img",{staticClass:"preview-image",attrs:{src:e.previewImage}})]),o("q-card-actions",{staticClass:"q-pa-none",staticStyle:{position:"absolute",bottom:"0",right:"0"},attrs:{align:"right"}},[o("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",padding:"none",size:"20px",icon:"close",color:"grey"}})],1)],1)],1)],1)},s=[],l=(o("e01a"),o("4aad")),n=o("2de9"),i=o("0ebe"),r=o("ed08"),d=o("6277"),c=(o("a79d"),o("ddb0"),o("4069"),o("0613"));o("997a"),o("e9c4");const h=!0,u=function(e={},...t){if(!h)return;const{tags:o,type:a,styles:s}=Object.assign({tags:[],type:"log",styles:[{bgc:"rgb(247,247,247)",color:"black"},{bgc:"rgb(96,96,96)",color:"white"}]},e),l=Array.from(o,((e,t)=>{const a=s[(t+1)%2],l=[`background-color: ${a.bgc}`,`color: ${a.color}`];return l.push("padding: 2px 12px"),0===t&&l.push("border-top-left-radius: 8px","border-bottom-left-radius: 8px"),t===o.length-1&&l.push("border-top-right-radius: 8px","border-bottom-right-radius: 8px"),l.join("; ")})),n=o.map((e=>`%c${e}`)).join("");console[a](n,...l,...t)},g={log:{type:"log"},warn:{type:"warn"},error:{type:"error"},red:{styles:[{bgc:"rgb(248,160,160)",color:"black"},{bgc:"rgb(134,12,12)",color:"white"}]},green:{styles:[{bgc:"rgb(160,248,161)",color:"black"},{bgc:"rgb(35,154,17)",color:"white"}]},purple:{styles:[{bgc:"rgb(200,184,255)",color:"black"},{bgc:"rgb(44,31,162)",color:"white"}]},blue:{styles:[{bgc:"rgb(184,215,255)",color:"black"},{bgc:"rgb(31,107,162)",color:"white"}]},tags:e=>(...t)=>(e.options.tags=e.options.tags||[],e.options.tags.push(...t),p(e))},p=e=>new Proxy(e,{get(e,t,o){if("options"===t)return e.options||void 0;if(!Object.keys(g).includes(t))return;const a=(...e)=>u(a.options,...e);return a.options={},Object.assign(a.options,JSON.parse(JSON.stringify(e.options||{}))),"function"===typeof g[t]?g[t](a):(Object.assign(a.options,g[t]),p(a))}}),b=p(u);Object.defineProperties(u,Object.keys(g).reduce(((e,t)=>(e[t]={get(){return b[t]}},e)),{}));var m=u;const f=e=>new Promise((t=>{const o=setInterval((()=>{const a=e();void 0!==a&&(clearInterval(o),t(a))}),1e3)})),$={data(){return{previewImage:null}},computed:{showPreview:{set(e){this.previewImage=e||null},get(){return!!this.previewImage}}}},w={methods:{async initFilmRate(){const e=e=>{const t=new Date(e);if(!t||!t.valueOf())return;const o=Date.now();return t.setFullYear(t.getFullYear()+7),t.valueOf()<o?"PG":(t.setFullYear(t.getFullYear()+3),t.valueOf()<o?"PG-13":(t.setFullYear(t.getFullYear()+3),t.valueOf()<o?"R":(t.setFullYear(t.getFullYear()+4),t.valueOf()<o?"NC-17":void 0)))},t=async()=>{const e={type:"radio",model:"G"};e.items=[{label:this.$t("rate_g"),value:"G",tooltip:this.$t("rate_g_desc")},{label:this.$t("rate_pg"),value:"PG",tooltip:this.$t("rate_pg_desc")},{label:this.$t("rate_pg_13"),value:"PG-13",tooltip:this.$t("rate_pg_13_desc")},{label:this.$t("rate_r"),value:"R",tooltip:this.$t("rate_r_desc")},{label:this.$t("rate_nc_17"),value:"NC-17",tooltip:this.$t("rate_nc_17_desc")}];const t=this.$alphabiz.dialog({title:this.$t("set_film_rate"),message:this.$t("select_a_rate_before_enter"),options:e,ok:this.$t("ok")}),o=await t.promise("ok");if(o)return o.option},a=e=>{if(c["a"].dispatch("updateSettings",{libraryRate:e}),Object(r["isElectron"])()){const{ipcRenderer:t}=o("bdb9");t.send("set_settings",{libraryRate:e})}localStorage.setItem("set-film-rate",e)};if(localStorage.getItem("set-film-rate"))return;const s=await f((()=>{if(c["a"].getters.accountUserInfo&&c["a"].getters.accountUserInfo.sub)return c["a"].getters.accountUserInfo.birthday||null}));let l=e(s);l||(l=await t()),a(l)}},async activated(){await this.initFilmRate()}},v=m.blue.tags("LibLoader"),y=v.tags("Channel"),C=v.tags("Post"),P={data(){return{loader$loadedChannels:{}}},created(){this.$watch("followingChannels",(e=>{let t=!1;Object.keys(this.loader$loadedChannels).forEach((o=>{e.some((e=>e.id===o))||(delete this.loader$loadedChannels[o],t=!0)})),t&&(this.loader$loadedChannels=Object.assign({},this.loader$loadedChannels))}),{immediate:!0,deep:!0})},computed:{loader$toLoadChannels(){const e=this.followingChannels;return e.filter((e=>!(!e.title||!e.id)&&!this.loader$loadedChannels[e.id])).reduce(((e,t)=>(e[t.id]=t,e)),{})}},methods:{async loader$enableChannelsLoader({onLoaded:e},t){const o=async({onChannelLoaded:e,onChannelUpdated:t})=>{const o=Object.values(this.loader$toLoadChannels);await Promise.all(o.map((async o=>{const a=await l["a"].getChannelPostIds(o.id,!0);if(!this.loaderEnabled)return;const s=this.loader$loadedChannels[o.id];s?s.ids=a:this.loader$loadedChannels[o.id]={channel:o,ids:a},this.loader$loadedChannels=Object.assign({},this.loader$loadedChannels),await(s?t:e)(o.id)})))},a=()=>({toLoadCount:Object.keys(this.loader$toLoadChannels).length,loadedCount:Object.keys(this.loader$loadedChannels).length}),s=e=>new Promise((t=>setTimeout(t,e)));let n=!0;while(this.loaderEnabled){const l=a();if(!l.toLoadCount){if(n){e((()=>{const e=n;return n=!1,e})());continue}await s(t);continue}if(await o({onChannelLoaded:async e=>{if(!this.loaderEnabled)return;const{loadedCount:t,toLoadCount:o}=a(),s=`${t}/${t+o}`;y.tags("onLoaded",s).log(e)},onChannelUpdated:async e=>{this.loaderEnabled&&y.tags("onUpdated").log(e)}}),!this.loaderEnabled)break;const i=a();i.toLoadCount||(e((()=>{const e=n;return n=!1,e})()),await s(t))}}}},_={data(){return{loader$loadedPosts:{}}},computed:{loader$toLoadPosts(){return Object.values(this.loader$loadedChannels).map((({channel:e,ids:t})=>t.map((t=>({id:t,channelId:e.id}))))).flat(1).reduce(((e,t)=>(this.loader$loadedPosts[t.id]||(e[t.id]=t),e)),{})},loader$toLoadPostIdListSorted(){return Object.keys(this.loader$toLoadPosts).sort(((e,t)=>e&&t?e.localeCompare(t):0))}},created(){},methods:{async loader$loadPosts({count:e},{onPostsLoaded:t}){const o=async e=>{const{id:t,channelId:o}=e,a=this.loader$loadedChannels[o].channel,s=await l["a"].getPostById(o,t,!0);return s?(s.channel=a,s):null},a=e=>this.loader$toLoadPostIdListSorted.length?this.loader$toLoadPostIdListSorted.slice(0,e).map((e=>this.loader$toLoadPosts[e])):null,s=a(e);if(!s)return;const n=await Promise.all(s.map((async e=>{const t=await o(e);return t?(this.loader$loadedPosts[t.id]=t,{success:!0,id:t.id}):{success:!1,id:e.id,channelId:e.channelId}}))),i=n.filter((e=>e.success)).map((e=>e.id));return i.length&&(this.loader$loadedPosts=Object.assign({},this.loader$loadedPosts),await t(i)),n},async loader$loadPostsNext({count:e}={}){if(!Object.keys(this.loader$toLoadPosts).length)return;if("loaded"!==this.loaderState)return;this.loaderState="fetching";const t=async e=>{const t=()=>({toLoadCount:Object.keys(this.loader$toLoadPosts).length,loadedCount:Object.keys(this.loader$loadedPosts).length}),{loadedCount:o,toLoadCount:a}=t(),s=`${o}/${o+a}`;C.tags("onLoaded",s).log()};await this.loader$loadPosts({count:e},{onPostsLoaded:t}),this.loaderState="loaded"},async loader$initPostLoader({initialCount:e}={},{onPostsLoaded:t}={}){e=20,t=async e=>{const t=()=>({toLoadCount:Object.keys(this.loader$toLoadPosts).length,loadedCount:Object.keys(this.loader$loadedPosts).length}),{loadedCount:o,toLoadCount:a}=t(),s=`${o}/${o+a}`;C.tags("onLoaded",s).log()};const o=e=>new Promise((t=>setTimeout(t,e))),a=()=>({toLoadCount:Object.keys(this.loader$toLoadPosts).length,loadedCount:Object.keys(this.loader$loadedPosts).length}),s=()=>{const{toLoadCount:t,loadedCount:o}=a();return o&&(0===t||o>=e)};let l=!0;while(!s())await this.loader$loadPosts({count:10},{onPostsLoaded:t}),l?l=!1:await o(Math.round(3e3*Math.random()));C.log("loaded")}}},L={mixins:[P,_],data(){return{loaderState:"stopped"}},computed:{loaderEnabled(){return["loading","fetching","loaded","timeout"].includes(this.loaderState)}},created(){this.$watch("loaderState",((e,t)=>{let o=v.tags("State",e);const a={red:["timeout"]},s=Object.keys(a).find((t=>a[t].includes(e)));s&&(o=o[s]);const l={loading:"loading...",timeout:"timeout, maybe network error",fetching:"fetching next post slice",loaded:()=>{const e={loading:"loaded",timeout:"loaded but timeout"};return e[t]}};let n=l[e];"function"===typeof n&&(n=n()),n?o.log(n):o.log()}))},methods:{async enableLoader(){const e=e=>new Promise((t=>setTimeout(t,e))),t=async(t,o,a)=>{let s,l=!1;return await Promise.race([t.then((e=>{l=!0,s=e})),e(o).then((()=>{l||a&&(s=a())}))]),s};if(this.loaderEnabled)return;this.loaderState="loading";const o=1e4,a=async()=>{await new Promise((e=>this.loader$enableChannelsLoader({onLoaded:t=>{y.log(t?"loaded":"updated"),e(!0)}},1e4))),await this.loader$initPostLoader()},s=e=>{this.loaderEnabled&&(this.loaderState=e?"timeout":"loaded")};await t((async()=>{await a(),s(!1)})(),o,(()=>{s(!0)}))},async disableLoader(){this.loaderEnabled&&(this.loaderState="stopped")}}},k={methods:{loader$dialog(){const e=this.$alphabiz.dialog({title:this.$t("no_available_post"),message:this.$t("following_channel_no_post"),cancel:this.$t("cancel"),ok:this.$t("lib_explore")});return e.promise("ok").then((e=>{e&&(c["a"].getters.settings.libraryShowExplore||c["a"].dispatch("set",{libraryShowExplore:!0}),this.$root.$emit("navigate-to","/library/explore"),this.$router.push("/library/explore"))})),e}}},x={mixins:[L,k],computed:{loadedPosts(){return this.loader$loadedPosts}},created(){let e;this.$watch("loaderState",(t=>{if("timeout"===t){if(e)return;e=this.loader$dialog()}else{if(!e)return;e.hide(),e=null}}))},async activated(){const e=()=>{const e=Object.values(this.loader$loadedChannels).map((({ids:e})=>e)).flat(1),t=Object.keys(this.loader$loadedPosts).filter((t=>!e.includes(t)));t.forEach((e=>{delete this.loader$loadedPosts[e]})),t.length&&(this.loader$loadedPosts=Object.assign({},this.loader$loadedPosts))};e(),await l["a"].whenReady,this.enableLoader()},deactivated(){this.disableLoader()}};var O={name:"LibraryIndex",components:{PostCard:n["a"],SearchChannel:d["a"],BackToTop:i["a"]},mixins:[$,w,x],data(){return{isElectron:Object(r["isElectron"])(),scrollIndex:0,lib:l["a"]}},computed:{followingChannels(){var e,t;const o=(null===(e=l["a"].userData)||void 0===e?void 0:e.blockChannels)||[],a=(null===(t=l["a"].userData)||void 0===t?void 0:t.blockUsers)||[];return l["a"].followingChannels.filter((e=>!o.includes(e.id)&&!a.includes(e.creator)))},filteredPosts(){return Object.values(this.loadedPosts).filter((e=>l["a"].isValidRate(e.rate||"G")))},searchFilteredPosts(){const e=l["a"].search.text.toLowerCase(),t=l["a"].search.option.value,o=e=>{var o;switch(t){case"channel":return null===(o=e.channel)||void 0===o?void 0:o.title;case"channelID":return e.channel.id;case"description":return e.description;default:return e.title}},a=t=>{var a;return null===(a=o(t))||void 0===a?void 0:a.toLowerCase().includes(e)};return this.filteredPosts.filter(a)}},methods:{fetchNext({isIntersecting:e}){e&&this.loader$loadPostsNext({count:10})},itemsFn(e=0,t=5){return this.searchFilteredPosts.slice(e,e+t)},async unfollow(e){const t=this.$alphabiz.dialog({title:this.$t("unfollow"),message:this.$t("unfollow_confirm"),ok:this.$t("unfollow"),cancel:this.$t("cancel")}),o=await t.promise("ok");if(!o)return;const a=await l["a"].unfollowChannel(e);console.log("unfollowed",e,a)},toChannelPage(e){console.log("to",e);const t=["id","title"].map((t=>{const o=e[t];return encodeURIComponent(t)+"="+encodeURIComponent(o)})).join("&"),o=`/library/channel?${t}`;this.$root.$emit("navigate-to",o),this.$router.push(o)}},async activated(){const e=()=>{this.lib.setSearchOption([{label:this.$t("post_title"),value:"post"},{label:this.$t("description"),value:"description"},{label:this.$t("channel_title"),value:"channel"},{label:this.$t("channel_id"),value:"channelID"}])};this.$root.$emit("navigate-to"),e()}},j=O,I=(o("96f4"),o("2877")),S=o("a12b"),E=o("0016"),F=o("d9b2"),q=o("24e8"),z=o("f09f"),N=o("a370"),R=o("4b7e"),T=o("9c40"),U=o("9748"),Q=o("7f67"),Y=o("eebe"),D=o.n(Y),G=Object(I["a"])(j,a,s,!1,null,"1643bb31",null);t["default"]=G.exports;D()(G,"components",{QVirtualScroll:S["a"],QIcon:E["a"],QSpinnerIos:F["a"],QDialog:q["a"],QCard:z["a"],QCardSection:N["a"],QCardActions:R["a"],QBtn:T["a"]}),D()(G,"directives",{Intersection:U["a"],ClosePopup:Q["a"]})},"96f4":function(e,t,o){"use strict";o("c256")},c256:function(e,t,o){}}]);