(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[16],{3660:function(t,e,s){"use strict";s.r(e);var l=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"library-index"},[s("q-virtual-scroll",{ref:"vscroll",staticClass:"library-index-scroll",class:{web:!t.isElectron},attrs:{separator:"","virtual-scroll-slice-size":10,"virtual-scroll-item-size":385,"items-size":t.searchFilteredPosts.length,"virtual-scroll-sticky-size-end":16,"items-fn":t.itemsFn},on:{"virtual-scroll":t.onScroll},scopedSlots:t._u([{key:"default",fn:function(e){var l=e.item;return[s("PostCard",{key:l.id,attrs:{post:l,disableFollow:t.loadingNext},on:{preview:t.showPreviewImage,follow:t.unfollow,"to-channel":t.toChannelPage}})]}},{key:"after",fn:function(){return[s("div",{directives:[{name:"show",rawName:"v-show",value:!t.searchFilteredPosts.length&&!t.loadingPosts&&t.loadedAll,expression:"!searchFilteredPosts.length && !loadingPosts && loadedAll"}],staticClass:"empty-placeholder full-width text-center text-subtitle1 q-my-md"},[s("q-icon",{attrs:{name:"help_outline"}}),s("span",{staticClass:"empty-hint q-ml-sm"},[t._v(t._s(t.$t("credit_no_data")))])],1),s("div",{directives:[{name:"intersection",rawName:"v-intersection",value:t.shouldLoading,expression:"shouldLoading"}],staticClass:"full-width text-center"},[t.loadedAll&&!t.loadingPosts?s("div",{staticClass:"loaded-all"},[s("div",{staticClass:"loaded-hint"},[t._v(t._s(t.$t("got_all_post")))]),s("q-icon",{staticClass:"q-mb-md",attrs:{name:"done",size:"32px",color:"primary"}})],1):s("div",{staticClass:"loading-infinite",class:{transparent:t.showLoadingBackdrop}},[s("div",{staticClass:"loading-hint"},[t._v(t._s(t.$t("loading"))+" ...")]),s("q-circular-progress",{staticClass:"q-ma-md",attrs:{indeterminate:"",size:"32px",color:"primary"}})],1)])]},proxy:!0}])}),s("BackToTop",{attrs:{show:t.scrollIndex>0},on:{click:t.scrollTop}}),s("SearchChannel",{attrs:{higher:t.scrollIndex>0}}),s("q-dialog",{model:{value:t.showPreview,callback:function(e){t.showPreview=e},expression:"showPreview"}},[s("q-card",{staticClass:"image-preview-card"},[s("q-card-section",{staticClass:"q-pa-none"},[s("img",{staticClass:"preview-image",attrs:{src:t.previewImage}})]),s("q-card-actions",{staticClass:"q-pa-none",staticStyle:{position:"absolute",bottom:"0",right:"0"},attrs:{align:"right"}},[s("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",padding:"none",size:"20px",icon:"close",color:"grey"}})],1)],1)],1),s("q-dialog",{attrs:{persistent:""},model:{value:t.showSetFilmRate,callback:function(e){t.showSetFilmRate=e},expression:"showSetFilmRate"}},[s("q-card",[s("q-card-section",[s("div",{staticClass:"text-h6 title"},[t._v(t._s(t.$t("set_film_rate")))]),s("div",{staticClass:"text hint"},[t._v(t._s(t.$t("select_a_rate_before_enter")))]),s("q-select",{staticStyle:{width:"320px"},attrs:{"display-value":t.filmRate.label,options:t.filmRateOptions,outlined:"",dense:"","data-cy":"select-direct"},scopedSlots:t._u([{key:"option",fn:function(e){return[s("q-item",t._g(t._b({},"q-item",e.itemProps,!1),e.itemEvents),[s("q-item-section",[s("q-item-label",{domProps:{innerHTML:t._s(e.opt.label)}}),e.opt.caption?s("q-tooltip",t._l(e.opt.caption.split("\n"),(function(e,l){return s("span",{key:l,staticClass:"tooltip"},[t._v(t._s(e))])})),0):t._e()],1)],1)]}}]),model:{value:t.filmRate,callback:function(e){t.filmRate=e},expression:"filmRate"}})],1),s("q-card-actions",{attrs:{align:"right"}},[s("q-btn",{attrs:{flat:"",color:"primary"},on:{click:t.setFilmRate}},[t._v(t._s(t.$t("ok")))])],1)],1)],1),s("Loading",{attrs:{value:t.showLoadingBackdrop}})],1)},a=[],i=(s("e01a"),s("ddb0"),s("4aad")),o=s("2de9"),n=s("0ebe"),r=s("0613"),d=s("ed08"),h=s("ab9a"),c=s("6277"),u=s("997a"),p={name:"LibraryIndex",components:{PostCard:o["a"],Loading:h["a"],SearchChannel:c["a"],BackToTop:n["a"]},data(){return{isElectron:Object(d["isElectron"])(),active:!1,showPreview:!1,previewImage:"",loadingPosts:!1,parseInterval:null,allPosts:[],postLists:[],scrollStart:0,scrollSize:0,scrollIndex:0,loadTimer:null,loadedChannels:[],loadedPostIds:[],loadingNext:!1,loadedAll:!1,loadStartTime:Date.now(),loadingIntersecting:!0,showLoading:!1,showSetFilmRate:!1,noDataDialog:null,filmRate:{label:this.$t("rate_g"),value:"G",caption:this.$t("rate_g_desc")},filmRateOptions:[{label:this.$t("rate_g"),value:"G",caption:this.$t("rate_g_desc")},{label:this.$t("rate_pg"),value:"PG",caption:this.$t("rate_pg_desc")},{label:this.$t("rate_pg_13"),value:"PG-13",caption:this.$t("rate_pg_13_desc")},{label:this.$t("rate_r"),value:"R",caption:this.$t("rate_r_desc")},{label:this.$t("rate_nc_17"),value:"NC-17",caption:this.$t("rate_nc_17_desc")}],lib:i["a"]}},computed:{showLoadingBackdrop(){return"ready"===i["a"].libStatus&&this.loadingPosts&&!this.filteredPosts.length},currentScrollTop(){return this.$refs.vscroll},followingChannels(){var t,e;const s=(null===(t=i["a"].userData)||void 0===t?void 0:t.blockChannels)||[],l=(null===(e=i["a"].userData)||void 0===e?void 0:e.blockUsers)||[];return i["a"].followingChannels.filter((t=>!s.includes(t.id)&&!l.includes(t.creator)))},filteredPosts(){return this.allPosts.filter((t=>i["a"].isValidRate(t.rate||"G")))},searchFilteredPosts(){const t=i["a"].search.text.toLowerCase(),e=i["a"].search.option.value,s=t=>{var s;switch(e){case"channel":return null===(s=t.channel)||void 0===s?void 0:s.title;case"channelID":return t.channel.id;case"description":return t.description;default:return t.title}},l=e=>{var l;return null===(l=s(e))||void 0===l?void 0:l.toLowerCase().includes(t)};return this.filteredPosts.filter(l)},allPostsToFetch(){const t=[];return this.loadedChannels.forEach((({channel:e,ids:s})=>{s.forEach((s=>{this.loadedPostIds.includes(s)||t.push({channel:e,postId:s})}))})),t.sort(((t,e)=>t.postId&&e.postId?t.postId.localeCompare(e.postId):0)),t},scrollPosts(){return this.searchFilteredPosts.slice(this.scrollStart,this.scrollStart+this.scrollSize)}},methods:{scrollTop(){this.$refs.vscroll.scrollTo(0,"start")},onScroll(t){this.scrollIndex=t.index||0},shouldLoading(t){this.loadingIntersecting=t.isIntersecting,t.isIntersecting&&!this.loadingPosts&&this.loadNext()},async loadNext(){if(this.loadingNext)return;this.loadingNext=!0;const t=this.allPostsToFetch.slice(0,10).sort(((t,e)=>t.postId&&e.postId?t.postId.localeCompare(e.postId):0));if(!t.length)return this.loadingNext=!1,this.loadedAll=!0,void setTimeout((()=>{Object(u["a"])("Try load more"),this.loadPostList()}),5e3);this.loadedAll=!1;const e=[],s=await Promise.all(t.map((async({channel:t,postId:s})=>{const l=await i["a"].getPostById(t.id,s,!0);return l?(l.channel=t,l):(e.push(s),null)})));s.length&&!this.allPosts.length&&console.timeEnd("Enter library"),Object(u["a"])("Fetch results",s),s.forEach((t=>{t&&this.allPosts.push(t)})),this.loadedPostIds.push(...t.filter((t=>!e.includes(t.postId))).map((t=>t.postId))),this.loadingNext=!1,this.$nextTick((()=>{this.loadingIntersecting&&this.loadNext()}))},async loadPostList(){if(this.loadingPosts)return;if(this.loadStartTime+2e4<Date.now()){if(!this.active)return;if(this.loadingPosts=!1,this.noDataDialog)return;if(!this.allPosts.length){this.noDataDialog=this.$q.dialog({title:this.$t("no_available_post"),message:this.$t("following_channel_no_post"),ok:this.$t("lib_explore"),cancel:this.$t("cancel")});const t=this.$watch("allPosts",(e=>{e&&e.length&&this.noDataDialog&&(this.noDataDialog.hide(),this.noDataDialog=null,t())}));this.noDataDialog.onOk((()=>{r["a"].getters.settings.libraryShowExplore||r["a"].dispatch("set",{libraryShowExplore:!0}),this.$root.$emit("navigate-to","/library/explore"),this.$router.push("/library/explore"),this.noDataDialog=null,t()}))}return}this.loadingPosts=!0,Object(u["a"])("[Index] Load all",this.followingChannels);for(let s=0;s<this.loadedChannels.length;s++)this.followingChannels.some((t=>t.id===this.loadedChannels[s].channel.id))||this.loadedChannels.splice(s--,1);const t=this.followingChannels.filter((t=>!(!t.title||!t.id)&&!this.loadedChannels.find((e=>e.channel.id===t.id))));await Promise.all(t.map((async t=>{const e=await i["a"].getChannelPostIds(t.id,!0),s=this.loadedChannels.find((e=>e.channel.id===t.id));if(s?s.ids=e:this.loadedChannels.push({channel:t,ids:e}),!this.allPosts.length&&e.length){if(Date.now()-this.loadStartTime>5e3)return Object(u["a"])("LoadNext","since waiting for 5s"),this.loadNext();if(this.loadedChannels.length>=this.followingChannels.length)return Object(u["a"])("LoadNext","since loaded all followings",this.followingChannels.length),this.loadNext()}}))),this.allPosts.length?this.loadingPosts=!1:setTimeout((()=>{this.loadingPosts=!1,this.allPosts.length||this.loadPostList()}),2e3);const e=this.followingChannels.filter((t=>!(!t.title||!t.id)&&!this.loadedChannels.find((e=>e.channel.id===t.id))));if(e.length)Object(u["a"])("[Load]",e.length+" new channels are added when loading."),this.loadPostList();else{if(!this.loadingIntersecting)return;Object(u["a"])("LoadNext","since ready for all",this.followingChannels.length,this.allPostsToFetch.length),this.loadNext()}},parseAllPosts(){const t=[];for(const{channel:e,posts:s}of this.postLists)s.forEach((s=>{const l=Object.assign({channel:e},s),a=t.findIndex((t=>t.id===l.id));-1!==a?t.splice(a,1,l):t.push(l)}));this.allPosts=t.sort(((t,e)=>{const s=e.timestamp-t.timestamp;return 0===s?t.title.match(/^\d+/)&&e.title.match(/^\d+/)?parseInt(e.title)-parseInt(t.title):e.title.localeCompare(t.title):s}))},loadAllPosts(){if(this.loadingPosts)return;this.loadingPosts=!0;const t=this.followingChannels.map((t=>t.id)).filter((t=>{var e,s;return!(null!==(e=i["a"].userData)&&void 0!==e&&null!==(s=e.blockChannels)&&void 0!==s&&s.includes(t))}));for(let l=0;l<this.postLists.length;l++){var e;const s=null===(e=this.postLists[l].channel)||void 0===e?void 0:e.id;t.includes(s)||this.postLists.splice(l--,1)}const s=this.followingChannels.filter((t=>{var e,s;return!!t.title&&((null===(e=i["a"].userData.blockUsers)||void 0===e||!e.includes(t.creator))&&(null===(s=i["a"].userData.blockChannels)||void 0===s||!s.includes(t.id)))}));s.map((t=>{const e=this.postLists.findIndex((e=>{var s;return(null===(s=e.channel)||void 0===s?void 0:s.id)===t.id}));if(-1!==e)return;const s=[],l={channel:t,posts:s};-1===e?this.postLists.push(l):this.$set(this.postLists,e,l),i["a"].getChannelPosts(t.id,!0).then((t=>{this.$set(l,"posts",t),(t.length||this.filteredPosts.length)&&(this.loadingPosts=!1)}))})),setTimeout((()=>{this.loadingPosts=!1}),4e3)},loadAll(){if("ready"===i["a"].libStatus)i["a"].followingChannels.length?this.loadAllPosts():this.loadTimer=setTimeout((()=>{i["a"].followingChannels.length||this.loadAll()}),2e3);else{console.log("waiting for lib ready");const t=this.$watch("lib.libStatus",(e=>{"ready"===e&&(this.loadAll(),t())}))}},itemsFn(t=0,e=5){return this.scrollStart=t,this.scrollSize=e,this.scrollPosts},unfollow(t){this.$q.dialog({title:this.$t("unfollow"),message:this.$t("unfollow_confirm"),ok:this.$t("unfollow"),cancel:this.$t("cancel")}).onOk((()=>{i["a"].unfollowChannel(t).then((e=>{console.log("unfollowed",t,e)}))}))},prunePostList(){const t=this.followingChannels.map((t=>t.id));for(let l=0;l<this.loadedChannels.length;l++)t.includes(this.loadedChannels[l].channel.id)||this.loadedChannels.splice(l--,1);const e=this.loadedChannels.reduce(((t,e)=>(e.ids&&t.push(...e.ids),t)),[]);for(let l=0;l<this.allPosts.length;l++){var s;const a=this.loadedPostIds.findIndex((t=>this.allPosts[l].id===t));t.includes(null===(s=this.allPosts[l].channel)||void 0===s?void 0:s.id)&&e.includes(this.allPosts[l].id)||(this.allPosts.splice(l--,1),-1!==a&&this.loadedPostIds.splice(a,1))}for(let l=0;l<this.loadedPostIds.length;l++)this.allPosts.find((t=>t.id===this.loadedPostIds[l]))||this.loadedPostIds.splice(l--,1)},showPreviewImage(t){this.previewImage=t,this.showPreview=!0},toChannelPage(t){console.log("to",t);const e=["id","title"].map((e=>{const s=t[e];return encodeURIComponent(e)+"="+encodeURIComponent(s)})).join("&"),s=`/library/channel?${e}`;this.$root.$emit("navigate-to",s),this.$router.push(s)},tryAutoSetFilmRate(){if(!r["a"].getters.accountUserInfo||!r["a"].getters.accountUserInfo.sub)return setTimeout((()=>this.tryAutoSetFilmRate()),2e3);const t=new Date(r["a"].getters.accountUserInfo.birthday);if(t&&t.valueOf()){const e=Date.now();return t.setFullYear(t.getFullYear()+7),console.log("User is more than 7 years old"),t.valueOf()<e?(this.filmRate.value="PG",t.setFullYear(t.getFullYear()+3),console.log("User is more than 10 years old"),t.valueOf()<e?(this.filmRate.value="PG-13",t.setFullYear(t.getFullYear()+3),console.log("User is more than 13 years old"),t.valueOf()<e?(this.filmRate.value="R",t.setFullYear(t.getFullYear()+4),console.log("User is more than 17 years old"),t.valueOf()<e&&(this.filmRate.value="NC-17"),this.setFilmRate()):this.setFilmRate()):this.setFilmRate()):this.setFilmRate()}this.showSetFilmRate=!0},setFilmRate(){if(r["a"].dispatch("updateSettings",{libraryRate:this.filmRate.value}),Object(d["isElectron"])()){const{ipcRenderer:t}=s("34bb");t.send("set_settings",{libraryRate:this.filmRate.value})}localStorage.setItem("set-film-rate",this.filmRate.value),this.showSetFilmRate=!1,this.loadAll()},setSearch(){this.lib.setSearchOption([{label:this.$t("post_title"),value:"post"},{label:this.$t("description"),value:"description"},{label:this.$t("channel_title"),value:"channel"},{label:this.$t("channel_id"),value:"channelID"}])}},mounted(){this.setSearch()},async activated(){this.active=!0,this.$root.$emit("navigate-to"),localStorage.getItem("set-film-rate")||this.tryAutoSetFilmRate(),console.log("Lib index activated"),this.setSearch(),this.loadStartTime=Date.now(),await i["a"].whenReady,this.prunePostList(),this.loadPostList()},deactivated(){this.active=!1,clearInterval(this.parseInterval),clearTimeout(this.loadTimer),this.loadingPosts=!1},watch:{followingChannels:{handler(){console.log("following channels updated"),this.loadPostList()},deep:!0}}},g=p,f=(s("d7fc"),s("2877")),m=s("a12b"),v=s("0016"),w=s("58ea"),P=s("24e8"),b=s("f09f"),C=s("a370"),_=s("4b7e"),I=s("9c40"),x=s("ddd8"),y=s("66e5"),$=s("4074"),S=s("0170"),R=s("05c0"),L=s("9748"),F=s("7f67"),D=s("eebe"),k=s.n(D),q=Object(f["a"])(g,l,a,!1,null,"6c27eee6",null);e["default"]=q.exports;k()(q,"components",{QVirtualScroll:m["a"],QIcon:v["a"],QCircularProgress:w["a"],QDialog:P["a"],QCard:b["a"],QCardSection:C["a"],QCardActions:_["a"],QBtn:I["a"],QSelect:x["a"],QItem:y["a"],QItemSection:$["a"],QItemLabel:S["a"],QTooltip:R["a"]}),k()(q,"directives",{Intersection:L["a"],ClosePopup:F["a"]})},d7fc:function(t,e,s){"use strict";s("e2e6")},e2e6:function(t,e,s){}}]);